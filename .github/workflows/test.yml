name: Test

on: [push, pull_request]

jobs:
  build:

    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: [3.9]

    steps:
    - uses: actions/checkout@v2

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        ./.ghwf-$(uname).sh
        ./install.sh
        pip install pynvim
        pip install pytest
        wget https://github.com/Kitware/CMake/releases/download/v3.21.3/cmake-3.21.3-linux-x86_64.sh
        chmod +x cmake*sh
        ./cmake*.sh --skip-license --prefix="$HOME/bin"
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: Run tests
      run: |
        ./test/all.sh

    - name: Archive script logs
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: logs-${{ matrix.os }}
        path: test/*.log
